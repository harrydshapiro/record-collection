# Docker Compose configuration for record-collection
# Run with: docker compose up --build

services:
  # MPD (Music Player Daemon) service
  mpd:
    image: tobi312/rpi-mpd:alpine
    container_name: record-collection-mpd
    volumes:
      - ./mpd.conf:/etc/mpd.conf:ro
      - /mnt/music/music:/music:ro
      - mpd-data:/var/lib/mpd
    ports:
      - "${MPD_CONTROL_PORT}:6600"   # MPD control port
      - "${MPD_STREAM_PORT}:8000"    # HTTP audio stream
    devices:
      - /dev/snd:/dev/snd            # Audio device access
    group_add:
      - audio                        # Audio group for ALSA access
    restart: unless-stopped

  # Node.js server serving the React client
  server:
    build:
      context: .
      args:
        REACT_APP_BACKEND_URL: ${REACT_APP_BACKEND_URL}
    container_name: record-collection-server
    environment:
      NODE_ENV: ${NODE_ENV}
      MPD_HOST: ${MPD_HOST}
      MPD_PORT: ${MPD_PORT}
      # Public-facing host for generating URLs
      HOST: ${HOST}
      LIBRARY_ROOT_PATH: ${LIBRARY_ROOT_PATH}
    volumes:
      # Mount music library so server can read cover art
      - /mnt/music/music:/music:ro
    ports:
      - "${SERVER_PORT}:4000"
    depends_on:
      - mpd
    restart: unless-stopped

volumes:
  mpd-data:
